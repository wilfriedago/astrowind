---
---

<script>
	const storageKey = 'theme-preference';

	const onClick = () => {
		// flip current value
		theme.value = theme.value === 'light' ? 'dark' : 'light';

		setPreference();
	};

	const getColorPreference = () => {
		if (localStorage.getItem(storageKey)) return localStorage.getItem(storageKey);
		else return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
	};

	const setPreference = () => {
		localStorage.setItem(storageKey, theme.value);
		reflectPreference();
	};

	const reflectPreference = () => {
		document.firstElementChild.setAttribute('data-theme', theme.value);

		document.firstElementChild.classList.toggle('dark', theme.value === 'dark');

		document.querySelector('#theme-toggle')?.setAttribute('aria-label', theme.value);
	};

	const theme = {
		value: getColorPreference(),
	};

	// set early so no page flashes / CSS is made aware
	reflectPreference();

	const attachEvent = (selector, event, fn) => {
		const matches = document.querySelectorAll(selector);
		if (matches && matches.length) {
			matches.forEach((elem) => {
				elem.addEventListener(event, () => fn(elem), false);
			});
		}
	};

	window.onload = () => {
		// set on load so screen readers can see latest value on the button
		reflectPreference();

		attachEvent('[data-aw-toggle-menu]', 'click', function (elem) {
			elem.classList.toggle('expanded');
			document.body.classList.toggle('overflow-hidden');
			document.getElementById('menu')?.classList.toggle('hidden');
		});

		attachEvent('[data-aw-toggle-color-scheme]', 'click', onClick);
	};

	// sync with system changes
	window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ({ matches: isDark }) => {
		theme.value = isDark ? 'dark' : 'light';
		setPreference();
	});

	window.onpageshow = function () {
		const elem = document.querySelector('[data-aw-toggle-menu]');
		if (elem) {
			elem.classList.remove('expanded');
		}
		document.body.classList.remove('overflow-hidden');
		document.getElementById('menu')?.classList.add('hidden');
	};
</script>
